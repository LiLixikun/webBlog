<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="nav">
        <a href="#/page1">page1</a>
        <a href="#/page2">page2</a>
        <a href="#/page3">page3</a>
        <a href="#/page4">page4</a>
        <a href="#/page5">page5</a>
    </div>
    <div id="nav">
        <a href="/page1">HistoryRouterpage1</a>
        <a href="/page2">HistoryRouterpage2</a>
        <a href="/page3">HistoryRouterpage3</a>
        <a href="/page4">HistoryRouterpage4</a>
        <a href="/page5">HistoryRouterpage5</a>
        <button id="btn">跳转</button>
    </div>
    <div id="contain"></div>
    <!-- <script>
        class HasRouter {

            constructor() {
                //用于储存不同has值对应的回调函数 
                this.routers = {};
                //监听has 变化
                window.addEventListener("hashchange", this.load.bind(this), false)
            }

            //用于注册每个视图
            register(has, calllback = function () { }) {
                this.routers[has] = calllback;
            }

            //用于注册首页
            registerIndex(calllback = function () { }) {
                this.routers['index'] = calllback;
            }


            //用于处理未找到视图
            registerNoFound(calllback = function () { }) {
                this.routers['404'] = calllback;
            }


            registerError(calllback = function () { }) {
                this.routers['error'] = calllback;
            }

            load() {
                let hash = location.hash.slice(1);
                let handle;
                //没有has默认首页
                if (!hash) {
                    handle = this.routers.index;
                }
                // 处理未找到情况
                else if (!this.routers.hasOwnProperty(hash)) {
                    handle = this.routers['404'] || function () { }
                } else {
                    handle = this.routers[hash]
                }

                // 执行注册的回调函数
                try {
                    handle.call(this);
                } catch (error) {
                    console.log(error);

                    (this.routers['error'] || function () { }).call(this, error)
                }

            }
        }

        let router = new HasRouter();
        let contain = document.getElementById("contain");
        router.registerIndex(() => contain.innerHTML = "我是首页");

        router.register("/page1", () => contain.innerHTML = "我是page1");
        router.register("/page2", () => contain.innerHTML = "我是page2");
        router.register("/page3", () => contain.innerHTML = "我是page3");
        router.register("/page4", () => { throw new Error("抛错@!") });

        router.load();
        router.registerNoFound(() => contain.innerHTML = "页面未找到!");
        router.registerError(() => contain.innerHTML = "页面跑出来一个错误!");
    </script> -->

    <script>

        // history

        class HistoryRouter {
            constructor() {
                this.routers = {};
                this.listenLink();
                this.listenPopState();
            }

            //监听 popState  处理前进后退
            listenPopState() {
                window.addEventListener("popstate", (e) => {
                    let state = e.state || {},
                        path = e.path || '';
                    this.dealPathHandler(path)
                }, false)
            }

            //全局监听 A 链接
            listenLink() {
                window.addEventListener('click', (e) => {
                    let dom = e.target;
                    if (dom.tagName.toUpperCase() === "A" && dom.getAttribute('herf')) {
                        e.preventDefault();
                        this.push(dom.getAttribute('herf'))
                    }
                }, false)
            }

//首页进入页面调用
load(){
    let path=location.pathname;
    this.dealPathHandler(path)
}

            //用于注册每个视图
            register(path, calllback = function () { }) {
                this.routers[path] = calllback;
            }

            //注册首页
            registerIndex(calllback = function () { }) {
                this.routers['/'] = calllback
            }

            registerNoFound(calllback = function () { }) {
                this.routers['404'] = calllback
            }

            registerError(calllback = function () { }) {
                this.routers["error"] = calllback;
            }

            //页面跳转
            push(path) {
                history.pushState(path, null, path)
            }

            //替换当前页面
            replace(path) {
                history.replaceState({ path }, null, path);
            }

            dealPathHandler(path) {
                let handle;
                if (!this.routers.hasOwnProperty(path)) {
                    handle = this.routers['404'] || function () { }
                } else {
                    handle = this.routers[path]
                }

                try {
                    handle.call(this)
                } catch (error) {
                    (this.routers['error'] || function () { }).call(this, error);
                }
            }
        }

        let router = new HistoryRouter();
        let contain = document.getElementById("contain");
        router.registerIndex(() => contain.innerHTML = "我是首页");

        router.register("/page1", () => contain.innerHTML = "我是page1");
        router.register("/page2", () => contain.innerHTML = "我是page2");
        router.register("/page3", () => contain.innerHTML = "我是page3");
        router.register("/page4", () => { throw new Error("抛错@!") });

    
        router.registerNoFound(() => contain.innerHTML = "页面未找到!");
        router.load()
        document.getElementById("btn").onclick=function(){
            router.push("/page5")
        }
    </script>
</body>

</html>